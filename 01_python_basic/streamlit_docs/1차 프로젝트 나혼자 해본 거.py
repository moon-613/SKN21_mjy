import streamlit as st
import pandas as pd
import random 

# 1. í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ìˆ˜ë„ê¶Œ íì°¨ì¥ ì¡°íšŒ ë° FAQ ì‹œìŠ¤í…œ",
    page_icon="ğŸš™",
    layout="wide",
    initial_sidebar_state="expanded"
)

# 2. ì‚¬ì´ë“œë°” ë©”ë‰´ êµ¬í˜„
st.sidebar.title("ğŸ› ï¸ ì‹œìŠ¤í…œ ë©”ë‰´")
menu = st.sidebar.radio(
    " ì›í•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”: ",
    ('íì°¨ì¥ ì¡°íšŒ', 'FAQ ê²€ìƒ‰ ì‹œìŠ¤í…œ', 'í†µê³„ ì‹œê°í™”', 'SQL ì§ˆì˜ ì§„í–‰')
)

# 3. ë©”ì¸ ì½˜í…ì¸  í•¨ìˆ˜ ì •ì˜
def show_scrapyard_finder():
    """ íì°¨ì¥ ì¡°íšŒ í˜ì´ì§€ """
    st.header ("ğŸ“ìˆ˜ë„ê¶Œ íì°¨ì¥ ì¡°íšŒ")
    st.write("ì§€ì—­ ë˜ëŠ” ì—…ì²´ëª…ìœ¼ë¡œ ë“±ë¡ëœ íì°¨ì¥ ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”.")

    col1, col2 = st.columns(1)

    with col1:
        selected_area = st.selectbox(
            "ì§€ì—­ë³„ ê²€ìƒ‰",
            ['ì „ì²´', 'ì„œìš¸', 'ê²½ê¸°', 'ì¸ì²œ'],
            index = 0   # ê¸°ë³¸ê°’ 'ì „ì²´'
        )
    with col2:
        search_name = st.text_input("ì—…ì²´ëª… ê²€ìƒ‰ (í‚¤ì›Œë“œ)", max_chars=50)


# ------------------------------------------------------------

# ê²€ìƒ‰ ë²„íŠ¼
    if st.button("íì°¨ì¥ ëª©ë¡ ê²€ìƒ‰"):
        # ê²€ìƒ‰ ì¡°ê±´ì— ë”°ë¼ í•¨ìˆ˜ í˜¸ì¶œ
        area_filter = selected_area if selected_area != 'ì „ì²´' else None
        
        # ğŸš¨ DB í•¨ìˆ˜ í˜¸ì¶œ (í˜„ì¬ëŠ” Mock í•¨ìˆ˜ ì‚¬ìš©)
        result_df = get_scrapyard_list(area=area_filter, name=search_name)

        if not result_df.empty:
            st.success(f"ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” íì°¨ì¥ **{len(result_df)}** ê±´ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.")
            
            # ìƒì„¸ ì •ë³´ í‘œì‹œ
            st.dataframe(
                result_df[['ì—…ì²´ëª…', 'ì§€ì—­', 'ì£¼ì†Œ', 'ì—°ë½ì²˜']], 
                use_container_width=True,
                hide_index=True
            )
            
            # ì§€ë„ ê¸°ë°˜ ì‹œê°í™” (ìœ„ë„/ê²½ë„ ì»¬ëŸ¼ì´ ìˆì–´ì•¼ í•¨)
            st.subheader("ğŸ—ºï¸ ì§€ë„ ê¸°ë°˜ ìœ„ì¹˜ ë³´ê¸°")
            st.map(result_df[['lat', 'lon']].rename(columns={'lat': 'latitude', 'lon': 'longitude'}))
            
        else:
            st.warning("í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” íì°¨ì¥ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")

def show_faq_system():
    """[2] FAQ ê²€ìƒ‰ ì‹œìŠ¤í…œ í˜ì´ì§€"""
    st.header("â“ íì°¨ ê´€ë ¨ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ (FAQ)")
    st.write("ê¶ê¸ˆí•œ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì‹œë©´ ê´€ë ¨ëœ ì§ˆë¬¸ê³¼ ë‹µë³€ì„ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤.")
    
    # ì‚¬ìš©ì ì…ë ¥: ê²€ìƒ‰ í‚¤ì›Œë“œ ìœ„ì ¯
    keyword = st.text_input("ê²€ìƒ‰ í‚¤ì›Œë“œ ì…ë ¥", max_chars=50, key="faq_keyword")
    
    if st.button("FAQ ê²€ìƒ‰"):
        if keyword:
            # ğŸš¨ DB í•¨ìˆ˜ í˜¸ì¶œ (í˜„ì¬ëŠ” Mock í•¨ìˆ˜ ì‚¬ìš©)
            faq_list = search_faq(keyword)
            
            if faq_list:
                st.info(f"'{keyword}'ì™€(ê³¼) ê´€ë ¨ëœ FAQ **{len(faq_list)}** ê±´ì´ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.")
                
                # ê²€ìƒ‰ ê²°ê³¼ë¥¼ í™•ì¥ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ì¶œë ¥
                for i, item in enumerate(faq_list):
                    # st.expanderë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹µë³€ì„ ìˆ¨ê²¨ ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ
                    with st.expander(f"**Q{i+1}.** {item['Q']}"):
                        st.markdown(f"**A.** {item['A']}")
                        st.caption(f"**ì¶œì²˜:** {item['ì¶œì²˜']}") # ì¶œì²˜ í‘œê¸°
            else:
                st.warning(f"'{keyword}'ì™€(ê³¼) ê´€ë ¨ëœ ì§ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        else:
            st.error("ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")


def show_statistics():
    """[3] í†µê³„ ì‹œê°í™” í˜ì´ì§€"""
    st.header("ğŸ“Š ìˆ˜ë„ê¶Œ íì°¨ì¥ í˜„í™© í†µê³„")
    st.write("ì €ì¥ëœ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ íì°¨ì¥ ë¶„í¬ í˜„í™©ì„ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.")
    
    # ğŸš¨ DB í•¨ìˆ˜ í˜¸ì¶œ (í˜„ì¬ëŠ” Mock í•¨ìˆ˜ ì‚¬ìš©)
    area_counts, trend_data, ratio_data = get_scrapyard_stats()
    
    # 3-1. ì§€ì—­ë³„ íì°¨ì¥ ìˆ˜ ë§‰ëŒ€ê·¸ë˜í”„
    st.subheader("1. ì§€ì—­ë³„ íì°¨ì¥ ìˆ˜")
    st.bar_chart(area_counts.set_index('ì§€ì—­'))
    st.dataframe(area_counts, hide_index=True)
    
    st.markdown("---")
    
    # 3-2. ë“±ë¡ì¼ìë³„ ì¶”ì´
    st.subheader("2. ì‹ ê·œ ë“±ë¡ì¼ìë³„ ì¶”ì´ (ì›”ë³„)")
    st.line_chart(trend_data.set_index('ë“±ë¡ì›”'))
    st.dataframe(trend_data, hide_index=True)
    
    st.markdown("---")
    
    # 3-3. ìˆ˜ë„ê¶Œ ë‚´ ë¹„ìœ¨ pie chart
    st.subheader("3. ìˆ˜ë„ê¶Œ íì°¨ì¥ ë¹„ìœ¨")
    
    # Streamlitì˜ ê¸°ë³¸ ì°¨íŠ¸ ëŒ€ì‹  Plotlyë¥¼ ì‚¬ìš©í•´ Pie Chartë¥¼ ë” ì˜ ì‹œê°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    try:
        import plotly.express as px
        fig = px.pie(
            ratio_data, 
            values='ë¹„ìœ¨', 
            names='ì§€ì—­', 
            title='ìˆ˜ë„ê¶Œ íì°¨ì¥ ìˆ˜ ë¹„ìœ¨',
            hole=.3 # ë„ë„› ì°¨íŠ¸ í˜•íƒœë¡œ í‘œì‹œ
        )
        st.plotly_chart(fig, use_container_width=True)
    except ImportError:
        # plotlyê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šì„ ê²½ìš°ë¥¼ ëŒ€ë¹„
        st.info("Plotly ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šì•„ íŒŒì´ ì°¨íŠ¸ê°€ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (pip install plotly)")
        st.dataframe(ratio_data, hide_index=True)

def show_sql_executor():
    """SQL ì§ˆì˜ ì‹¤í–‰ í˜ì´ì§€ (ì‹¤ìŠµ ëª©ì )"""
    st.header("ğŸ’» SQL ì§ˆì˜ ì‹¤í–‰ê¸°")
    st.warning("ì´ ê¸°ëŠ¥ì€ ë°ì´í„° ì¡°íšŒ í•™ìŠµ ë° ë””ë²„ê¹…ì„ ìœ„í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤. `SELECT` ë¬¸ë§Œ ì‚¬ìš©í•´ì£¼ì„¸ìš”.")
    
    query = st.text_area("SQL Query ì…ë ¥", 
                         value="SELECT * FROM scrapyard_table WHERE region = 'ì„œìš¸' LIMIT 5;", 
                         height=150,
                         key="sql_query_input")
    
    if st.button("ì¿¼ë¦¬ ì‹¤í–‰", key="execute_sql_button"):
        try:
            # ğŸš¨ DB í•¨ìˆ˜ í˜¸ì¶œ
            result_df = execute_custom_sql(query)
            
            st.success("ì¿¼ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.")
            st.dataframe(result_df, use_container_width=True)
            
        except Exception as e:
            st.error(f"ì¿¼ë¦¬ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")


# --------------------------------------------------------


# 4. ë©”ì¸ ë¼ìš°íŒ… (ë©”ë‰´ì— ë”°ë¼ ì½˜í…ì¸  í‘œì‹œ)

if menu == 'íì°¨ì¥ ì¡°íšŒ':
    show_scrapyard_finder()
elif menu == 'FAQ ê²€ìƒ‰ ì‹œìŠ¤í…œ':
    show_faq_system()
elif menu == 'í†µê³„ ì‹œê°í™”': # í†µê³„ ì‹œê°í™” ì¶”ê°€
    show_statistics()
elif menu == 'SQL ì§ˆì˜ ì‹¤í–‰':
    show_sql_executor()





#Project README.md
#Readme.mdëŠ” ë°œí‘œ ìë£Œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì‘ì„±í•œë‹¤.

#    íŒ€ì› ë° ë‹´ë‹¹ ì—…ë¬´
#í”„ë¡œì íŠ¸ ì£¼ì œ ë° ì£¼ì œ ì„¤ëª… ë° ì„ ì • ì´ìœ 
#ì£¼ì œë¥¼ ì„ íƒí•œ ì´ìœ  ì£¼ìš” ê¸°ëŠ¥í”„ë¡œì íŠ¸ë¥¼ êµ¬ì„±í•˜ëŠ” ë””ë ‰í† ë¦¬ë“¤ê³¼ íŒŒì¼ë“¤ì˜ êµ¬ì¡°.ìˆ˜ì§‘ ë°ì´í„° ì„¤ëª…ë°ì´í„° ë² ì´ìŠ¤ í…Œì´ë¸” ì„¤ëª…Applicationì˜ ì£¼ìš” ê¸°ëŠ¥

#    Application ì œê³µí•˜ëŠ” ê¸°ëŠ¥ ì„¤ëª…
#íšŒê³ : êµ¬í˜„ ë„ì¤‘ ìƒê²¼ë˜ ë¬¸ì œì™€ ì–´ë–»ê²Œ í•´ê²°í–ˆëŠ”ì§€ ì‘ì„±.
#ê°ì í”„ë¡œì íŠ¸ ì§„í–‰í•˜ë©´ì„œ ëŠë‚€ ì 

#1ì°¨ ë‹¨ìœ„ í”„ë¡œì íŠ¸
#ì£¼ì œ - ì „êµ­ ìë™ì°¨ ë“±ë¡ í˜„í™© ë° ê¸°ì—… FAQ ì¡°íšŒ ì‹œìŠ¤í…œ
#ìë™ì°¨ë‚˜ ìë™ì°¨ íšŒì‚¬ì™€ ê´€ë ¨ëœ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•´ì„œ Database ì— ì €ì¥ í›„ ê·¸ ë°ì´í„° ê¸°ë°˜ FAQ ì‹œìŠ¤í…œ êµ¬í˜„

#        ìë™ì°¨ì™€ ê´€ë ¨ëœ ë‹¤ì–‘í•œ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” FAQ(Frequently Asked Questions - ìì£¼ ë¬»ëŠ” ì§ˆë¬¸) ì‹œìŠ¤í…œ.
#            ì°¨ì™€ ê´€ë ¨ëœ ë‹¤ì–‘í•œ ì •ë³´ë¥¼ ì¤‘ ê´€ì‹¬ ìˆëŠ” ê²ƒì„ ì„ íƒí•´ì„œ ìˆ˜ì§‘.
#               ìˆ˜ì§‘í•œ ë°ì´í„°ë¥¼ Databaseì— ì €ì¥.

#ì €ì¥ëœ ë°ì´í„°ì— ëŒ€í•œ ì •ë³´ ì œê³µí•˜ëŠ” ì‹œìŠ¤í…œì„ streamlit ê¸°ë°˜ìœ¼ë¡œ êµ¬í˜„.í”„ë¡œì íŠ¸ ì£¼ ëª©ì 

#    í¬ë¡¤ë§ì„ ì´ìš©í•œ ë°ì´í„° ìˆ˜ì§‘ ì‹¤ìŠµ
#        ìˆ˜ì§‘í•œ ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì—  ì €ì¥í•˜ê³  ì¡°íšŒí•˜ì—¬ SQLì„ ì‹¤ìŠµ

# # ì¡°íšŒ ì§ˆì˜ë¥¼ ì‚¬ìš©ìë¡œ ë¶€í„° ì…ë ¥ë°›ì•„ ì¡°íšŒê²°ê³¼ë¥¼ ì¶œë ¥í•˜ëŠ” application êµ¬í˜„
#Github Repository
#https://github.com/orgs/SKNETWORKS-FAMILY-AICAMP/repositories

#ì‚°ì¶œë¬¼
#ì†ŒìŠ¤ ì½”ë“œ
#    ë°ì´í„° ì›¹ í¬ë¡¤ë§ ì½”ë“œ

#Application êµ¬í˜„ ì½”ë“œìˆ˜ì§‘/ì €ì¥í•œ ë°ì´í„° 

#    Databaseì— ë°ì´í„°ë¥¼ scriptë¡œ ì…ë ¥í–ˆì„ ê²½ìš° sql script íŒŒì¼. 
#        ì½”ë“œë¥¼ í†µí•´ ì…ë ¥ í–ˆìœ¼ë©´ python ì½”ë“œ íŒŒì¼ë“¤.

#csv, ì—‘ì…€ ë“± íŒŒì¼ì´ ìˆëŠ” ê²½ìš° ê·¸ íŒŒì¼ë“¤.ì‚°ì¶œë¬¼ ë¬¸ì„œ

#    ë°ì´í„° ë² ì´ìŠ¤ ì„¤ê³„ ë¬¸ì„œ
#        ë°ì´í„°ë² ì´ìŠ¤ ì •ì˜ì„œ
#            í…Œì´ë¸” ë‹¹ ë‹¤ìŒ ë‚´ìš©ì„ ì‘ì„±
#                í…Œì´ë¸” ì„¤ëª…(í…Œì´ë¸” ì´ë¦„, ì €ì¥í•˜ëŠ” ë°ì´í„°ì— ëŒ€í•œ ê°„ëµí•œ ì„¤ëª…)
#                    í…Œì´ë¸” ì»¬ëŸ¼ë“¤ ì„¤ëª…(í‘œë¡œ ì‘ì„±. ì†ì„±ì´ë¦„, ê²°ì¸¡ì¹˜ í—ˆìš©ì—¬ë¶€, ì œì•½ ì¡°ê±´, ê¸°ë³¸ê°’ ì„ ì„¤ëª…)

#ERDìˆ˜ì§‘ ë°ì´í„°

#    ìˆ˜ì§‘ ë°ì´í„°ì— ëŒ€í•œ ì„¤ëª…
#        ê° ë°ì´í„°ë¥¼ ì–´ë””ì—ì„œ ìˆ˜ì§‘í–ˆëŠ”ì§€.
#            ê° ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•œ ëª©ì 

#ê° ë°ì´í„°ì— ëŒ€í•œ ì„¤ëª…ë°ì´í„° ì¡°íšŒ í”„ë¡œê·¸ë¨ ì„¤ëª…

#    FAQ í”„ë¡œê·¸ë¨ì— ëŒ€í•œ ì„¤ëª…
#        ì‚¬ìš© ë©”ë‰´ì–¼ì„ ì‘ì„±í•œë‹¤.

